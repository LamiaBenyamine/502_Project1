---
title: "502_Project1"
author: "Ming Cai & Lamia Benyamine"
date: "2024-10-06"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

# INTRODUCTION

There are many methods to approximate the probability of success, p,
from a Binomial random sample, however, not all have the same coverage
probabilities or average length of the confidence interval. This report
will review several different methods using R and compare the
performance of the confidence intervals for various sample sizes and
probabilities for these three properties:

-   The proportion of intervals that capture the true value

-   The proportion that miss above and proportion that miss below

-   The average length of the interval

We will use data collected from 1,00 random samples from a binomial
distribution where n varies from 15, 13, to 100 and p varies from 0.01
to 0.99 across each approximation method. The methods reviewed in this
report are: Wald interval Adjusted Wald interval Clopper-Pearson (exact)
interval Score interval Raw percentile interval using a parametric
bootstrap Bootstrap t interval using a parametric bootstrap

# SIMULATION METHODS

## Wald Interval
The formula of calculating Wald interval is:

$$
\hat{p} - z_{1-\frac{\alpha}{2}}\sqrt{\frac{\hat{p}(1-\hat{p})}{n}} < p < \hat{p} + z_{1-\frac{\alpha}{2}}\sqrt{\frac{\hat{p}(1-\hat{p})}{n}},
$$

where the $z_c$ denotes the $c$ quantile of the standard normal distribution. 

To calculate the Wald interval for $p$, we need to use sample's probability $\hat{p}$, sample size $n$ and the confidence level $1-\alpha$. The function of calculating Wald Interval is given below:

```{r}
WaldCI <- function(y, n, alpha = 0.05){
  p_hat = y/n  # Estimate of the probability of success
  # Return lower and upper bound of Wald CI
  c("wald ci lower" = p_hat - qnorm(1-alpha/2)*sqrt((p_hat*(1-p_hat))/n),
    "wald ci upper" = p_hat + qnorm(1-alpha/2)*sqrt((p_hat*(1-p_hat))/n))
}
```
We use $\alpha = 0.05$ as default in all calculation.

## Adjusted Wald interval
To overcome the poor performance of Wald interval, adjusted Wald interval was proposed. The formula of adjusted Wald interval is almost the same as Wald interval, except that we add 2 successes and 2 failures to the sample data set:

$$
\tilde{p} - z_{1-\frac{\alpha}{2}}\sqrt{\frac{\tilde{p}(1-\tilde{p})}{n}} < p < \tilde{p} + z_{1-\frac{\alpha}{2}}\sqrt{\frac{\tilde{p}(1-\tilde{p})}{n}},
$$

where $\tilde{p} = (Y+2)/(n+4)$.

The function of calculating adjusted Wald Interval is given below:

```{r}
AdjWaldCI <- function(y, n, alpha = 0.05){
  p_tilde = (y+2)/(n+4)  # Adjusted estimate of probability of success
  # Return lower and upper bound of Adjusted Wald CI
  c("adj wald ci lower" = p_tilde - qnorm(1-alpha/2)*sqrt((p_tilde*(1-p_tilde))/n),
    "adj wald ci upper" = p_tilde + qnorm(1-alpha/2)*sqrt((p_tilde*(1-p_tilde))/n))
}

## Clopper-Pearson (exact) interval
Clopper-Pearson interval is referred to as "exact" interval. This interval is guaranteed to have coverage probability of at least $1 - \alpha$ for every value of $p$. When $y = 1,2, \cdots , n - 1$, the confidence interval is:

$$
\left[ 1 + \frac{n-y+1}{yF_{2y,2(n-y+1),\frac{\alpha}{2}}} \right]^{-1} < p < \left[ 1 + \frac{n-y}{(y+1)F_{2(y+1),2(n-y),1-\frac{\alpha}{2}}} \right]^{-1},
$$

where the $F_{a,b,c}$ denotes the $c$ quantile from the F distribution with degrees of freedom $a$ and $b$. 

When $y = 0$, we set the interval to be $[0,0]$ and When $y = n$, we set the interval to be $[1,1]$. The function of calculating Clopper-Pearson interval is given below:

```{r}
ClopperPearsonCI <- function(y, n, alpha = 0.05){
  # Handle special cases where y is 0 or y equals n
  if (y==0){
    c("C-P interval lower" = 0, 
      "C-P interval upper" = 0)
    } else if (y==n){
      c("C-P interval lower" = 1, 
        "C-P interval upper" = 1)
    } else {
      # General case for Clopper-Pearson CI using F-distribution
  c("C-P interval lower" = 1 / (1 + ((n-y+1) / (y * qf(alpha/2, 2*y, 2*(n-y+1))))), 
    "C-P interval upper" = 1 / (1 + ((n-y) / ((y+1) * qf(1-(alpha/2), 2*(y+1), 2*(n-y))))))
    }
}
```
## Score interval

Score tests, and in particular their standard errors, are based on the
log-likelihood at the null hypothesis value of the parameter, whereas
Wald tests are based on the log-likelihood at the maximum likelihood
estimate. Score interval can be used with almost all sample sizes and $p$ values. The formula is given below:

$$
\frac{\hat{p}+\frac{z_{1-\frac{\alpha}{2}}^2}{2n}-z_{1-\frac{\alpha}{2}}\sqrt{\frac{\hat{p}(1-\hat{p}) + \frac{z_{1-\frac{\alpha}{2}}^2}{4n}}{n}}}{1+\frac{z_{1-\frac{\alpha}{2}}^2}{n}} < p < \frac{\hat{p}+\frac{z_{1-\frac{\alpha}{2}}^2}{2n}+z_{1-\frac{\alpha}{2}}\sqrt{\frac{\hat{p}(1-\hat{p}) + \frac{z_{1-\frac{\alpha}{2}}^2}{4n}}{n}}}{1+\frac{z_{1-\frac{\alpha}{2}}^2}{n}},
$$

where the $z_c$ denotes the $c$ quantile of the standard normal distribution.

And the function of calculating Score interval is given below:

```{r}
ScoreCI <- function(y, n, alpha = 0.05){
  p_hat = y/n # Estimate of probability of success
  z = qnorm(1-alpha/2) # Z-score for the desired confidence level
  # Return lower and upper bound of Score CI
  c("Score interval lower" = 
      (p_hat + z^2/(2*n) - z*sqrt((p_hat*(1-p_hat) + z^2/(4*n))/n)) / (1 + z^2/n),
    "Score interval upper" = 
      (p_hat + z^2/(2*n) + z*sqrt((p_hat*(1-p_hat) + z^2/(4*n))/n)) / (1 + z^2/n))
}
```

## Raw percentile interval and Bootstrap t interval function (both using a parametric bootstrap)

To find the Raw percentile interval, we need to find the $\frac{\alpha}{2}$ quantile and the $1-\frac{\alpha}{2}$ quantile of the $\hat{p}$ of samples.

$$
\hat{p}_{\frac{\alpha}{2}} < p < \hat{p}_{1-\frac{\alpha}{2}} 
$$

where the $\hat{p}_{c}$ denotes the $c$ quantile of the proportion of the samples.

To find the Bootstrap t interval, we use following steps:

1. Calculate the mean of our sample's $\hat{p}$ to generate bootstrapped $\hat{p}_{boot}$, 

2. Use the mean of bootstrapped $\hat{p}_{boot}$ to generate secondary bootstrapped $\hat{p}_{boot2}$,

3. Use secondary bootstrapped $\hat{p}_{boot2}$ to find the estimated standard error of $\hat{p}_{boot}$,

4. Calculate the interval based on formula.

$$
\hat{p} - t_{1-{\frac{\alpha}{2}}}\cdot \hat{SE} < p < \hat{p} - t_{\frac{\alpha}{2}}\cdot \hat{SE}
$$

where the $t_{c}$ denotes the $c$ quantile of the bootstrapped t values, and

$$
T = \frac{\underset{\sim}{\hat{p}}-p}{\underset{\sim}{\hat{SE}}(\underset{\sim}{\hat{p}})}
$$

The function of finding Raw percentile interval and Bootstrap t interval is given below:

```{r}
BootstrapCI <- function(x, n, size, B, alpha = 0.05){
 
   # Special case handling when x = 0 or x = size
  if (x == 0) {
    return(c(0, 0, 0, 0))  # Raw and t-bootstrap intervals set to [0, 0]
  } else if (x == size) {
    return(c(1, 1, 1, 1))  # Raw and t-bootstrap intervals set to [1, 1]
  } else {
    sample_p <- x/size # Estimate proportion
    
  # Calculate raw percentile interval from bootstrap samples
  raw_lower <- quantile(sample_p, alpha / 2, na.rm = TRUE)
  raw_upper <- quantile(sample_p, 1 - alpha / 2, na.rm = TRUE)
  raw_interval <- c(raw_lower, raw_upper)
  
  # Bootstrap t interval calculations
  p_hat <- mean(sample_p)
  boot_estimates <- replicate(B, {
    sim_data <- rbinom(n, size, prob = p_hat)  # Generate bootstrap sample
    p_hat_boot <- mean(sim_data / size)  # Bootstrap estimate of proportion
    
    # Perform secondary bootstrap for standard error estimation
    B2 <- 50
    secondary_boot <- replicate(B2, {
      sim_data2 <- rbinom(n, size, prob = p_hat_boot)  # Second bootstrap sample
      p_hat_boot2 <- mean(sim_data2 / size)  # Bootstrap estimate
      return(p_hat_boot2)
    })
    
    estimated_SE_p_hat_boot <- sd(secondary_boot)  # Standard error
    if (estimated_SE_p_hat_boot == 0) return(NA)  # Handle division by zero
    
    # Calculate t-statistic
    p_boot_t <- (p_hat_boot - p_hat) / estimated_SE_p_hat_boot
    return(p_boot_t)
  })
  
  # Calculate the t-bootstrap intervals using quantiles
  boot_t_interval <- c(p_hat - quantile(boot_estimates, 1 - alpha / 2, na.rm = TRUE) * sd(boot_estimates),
                       p_hat - quantile(boot_estimates, alpha / 2, na.rm = TRUE) * sd(boot_estimates))
  
  # Return both raw percentile and t-bootstrap intervals
  return(c(raw_interval, boot_t_interval))
  }
}
```

# RESULTS

# CONCLUSION
